<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>사전선택 테스트</title>

  <link rel="icon" href="https://www.gwp.or.kr/images/icon/iconpack/box.png" />

  <script type="text/javascript" src="https://www.gwp.or.kr/js/lib/alpinejs/alpinejs.cdn.min.js" defer></script>

  <link rel="stylesheet" href="/js/lib/bootstrap/v5.3.3/bootstrap.min.css"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" rel="stylesheet">
  <script type="text/javascript" src="/js/lib/bootstrap/v5.3.3/bootstrap.bundle.min.js"></script>

  <script type="text/javascript" src="/js/lib/inputmask/dist/inputmask.min.js"></script>
  <script type="text/javascript" src="/jehu/js/moment.min.js"></script>
  <script type="text/javascript" src="/jehu/js/ko.min.js"></script>

  <!-- tabulator -->
  <link href="https://www.gwp.or.kr/js/lib/tabluator/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://www.gwp.or.kr/js/lib/tabluator/tabulator.min.js"></script>
  <link href="https://www.gwp.or.kr/js/lib/tabluator/tabulator_bootstrap5.min.css" rel="stylesheet">

  <script type="text/javascript" src="https://www.gwp.or.kr/js/lib/easepick/index.umd.min.js"></script>


  <script type="text/javascript" src="/js/lib/pako.min.js"></script>
  <script type="text/javascript" src="https://www.gwp.or.kr/jehu/js/qrcode.min.js"></script>


  <script type="text/javascript" src="/js/nxt/nxtUtil.js"></script>

  <style>
      table>td>th{
          font-size: .7em;
      }
      .tabulator-editable{
          border: 1px dotted var(--bs-green)!important;
          border-radius: 4px;
      }
  </style>

</head>
<body>

<div class="container-fluid p-5 w-100"  x-data="init()" x-init="loadData()">

  <h3>사전선택 테스트용 페이지</h3>

  <form class="row g-3 mt-4 p-3 border-1 rounded-3 shadow align-items-center" onsubmit="return false">

    <div class="my-3 row">
      <div class="col-2">
        <label for="bseYr">기준연도</label>
        <input type="number" id="bseYr" class="form-control" required
               x-model="bseYr" :min="new Date().getFullYear()" :max="new Date().getFullYear()+1">
      </div>
      <div class="col-2">
        <label for="chldIsrAgRstcYr">자녀나이 제한연도</label>
        <input type="number" id="chldIsrAgRstcYr" class="form-control"
               x-model="chldIsrAgRstcYr" :max="bseYr" required>
      </div>
      <div class="col-1">
        <span class="form-text" x-text='getRstcYr()'></span>
      </div>
      <div class="col-4">
        <label for="isrSlcDt">보험선택기간</label>
        <input type="text" id="isrSlcDt" class="form-control"
               x-ref="isrSlcDt" required>
        <div class="invalid-feedback"></div>
      </div>
      <div class="col-3">
        <label for="instNm">기관명</label>
        <input type="text" id="instNm" class="form-control"
               x-model="instNm" required>
        <div class="invalid-feedback"></div>
      </div>
    </div>


    <div class="mb-3 row">
      <div class="col-2">
        <label for="pseFnm">성명</label>
        <input type="text" id="pseFnm" autofocus x-model="pseFnm" required
               @focus="$event.target.select()"
               :class="validFnm()?'form-control is-valid':'form-control is-invalid'"
        >
        <div class="invalid-feedback">올바른 성명을 입력하세요🤬</div>
      </div>
      <div class="col-3">
        <label for="pseRrno">주민번호</label>
        <input type="text" id="pseRrno" class="form-control"
               style="font-family: monospace, monospace"
               x-ref="pseRrno" x-model="pseRrno" @keyup="validRrno($el)"
               x-init="Inputmask({mask: '999999-9999999', keepStatic: true, placeholder: '0', autoUnmask: true}).mask($el);"
               required>
        <div class="invalid-feedback">주민번호가 이상합니다.🤷‍♀️</div>
      </div>
      <div class="col-4">
        <span class="form-text rrno-info"></span>
      </div>
    </div>

    <div class="accordion d-none" id="accordion-sps">
      <div class="accordion-item">
        <h4 class="accordion-header">
          <button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#collapse-sps" aria-expanded="true" aria-controls="collapse-sps">
            배우자
          </button>
        </h4>
        <div id="collapse-sps" class="accordion-collapse collapse show" data-bs-parent="#accordion-sps">
          <div class="accordion-body">
            <div class="row m-0 p-1">
              <div class="col-md-1 form-check form-switch">
                <label for="spsUse">배우자</label>
                <input type="checkbox" id="spsUse" role="switch" class="form-check-input" x-model="spsUse">
              </div>

              <div class="col-md-1 form-check d-none">
                <label for="spsCop">공무원</label>
                <input type="checkbox" id="spsCop" class="form-check-input"
                       x-model="spsCop" :disabled="!spsUse">
              </div>

              <div class="col-md-2">
                <input type="text" id="spsName" class="form-control" placeholder="이름을 입력하세요"
                       x-model="spsName" :disabled="!spsUse" x-ref="spsNameEL">
              </div>

              <div class="col-md-4">
                <div class="row">
                  <div class="col-6">
                    <input type="text" id="spsRrno" class="form-control" placeholder="주민번호"
                           x-model="spsRrno" @keyup="validRrno($el)"
                           x-ref="spsRrnoEL"
                           x-init="()=>{
                  Inputmask({mask: '999999-9999999', keepStatic: true, placeholder: '0', autoUnmask: true}).mask($el);
                  $nextTick(()=>validRrno($el))
                }"
                           :disabled="!spsUse"
                    >
                    <div class="invalid-feedback">주민번호가 이상합니다.🤷‍♀️</div>
                  </div>
                  <div class="col-6">
                    <span class="form-text rrno-info"></span>
                  </div>
                </div>
              </div>

              <div class="col-md-2">
                <input type="tel" id="spsTel" class="form-control" placeholder="010-0000-0000"
                       x-model="spsTel"
                       x-init="Inputmask({mask: '999-9999-9999', keepStatic: true, placeholder: '010-0000-0000', autoUnmask: true}).mask($el);"
                       :disabled="!spsUse"
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>



    <div class="accordion d-none" id="accordion-child">
      <div class="accordion-item">
        <h4 class="accordion-header">
          <button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#collapse-child" aria-expanded="true" aria-controls="collapse-child">
            자녀
          </button>
        </h4>
        <div id="collapse-child" class="accordion-collapse collapse show" data-bs-parent="#accordion-sps">
          <div class="accordion-body">
            <div class="row m-0 p-1">
              <div class="col-md-1 form-check form-switch">
                <label for="child1Use">자녀1</label>
                <input type="checkbox" id="child1Use" role="switch" class="form-check-input" x-model="child1Use">
              </div>

              <div class="col-md-2">
                <input type="text" id="child1Name" class="form-control" placeholder="이름을 입력하세요"
                       x-model="child1Name" :disabled="!child1Use" x-ref="child1NameEL">
              </div>

              <div class="col-md-4">
                <div class="row">
                  <div class="col-6">
                    <input type="text" id="child1Rrno" class="form-control" placeholder="주민번호"
                           x-model="child1Rrno" @keyup="validRrno($el)"
                           x-ref="child1RrnoEL"
                           x-init="()=>{
                      Inputmask({mask: '999999-9999999', keepStatic: true, placeholder: '0', autoUnmask: true}).mask($el);
                      $nextTick(()=>validRrno($el))
                    }"
                           :disabled="!child1Use"
                    >
                    <div class="invalid-feedback">주민번호가 이상합니다.🤷‍♀️</div>
                  </div>
                  <div class="col-6">
                    <span class="form-text rrno-info"></span>
                  </div>
                </div>
              </div>

              <div class="col-md-2">
                <input type="tel" id="child1Tel" class="form-control" placeholder="010-0000-0000"
                       x-model="child1Tel"
                       x-init="Inputmask({mask: '999-9999-9999', keepStatic: true, placeholder: '010-0000-0000', autoUnmask: true}).mask($el);"
                       :disabled="!child1Use"
                >

              </div>

            </div>

            <div class="row m-0 p-1">
              <div class="col-md-1 form-check form-switch">
                <label for="child2Use">자녀2</label>
                <input type="checkbox" id="child2Use" role="switch" class="form-check-input" x-model="child2Use">
              </div>

              <div class="col-md-2">
                <input type="text" id="child2Name" class="form-control" placeholder="이름을 입력하세요"
                       x-ref="child2NameEL"
                       x-model="child2Name"
                       :disabled="!child2Use"
                >
              </div>

              <div class="col-md-4">
                <div class="row">
                  <div class="col-6">
                    <input type="text" id="child2Rrno" class="form-control" placeholder="주민번호"
                           x-model="child2Rrno" @keyup="validRrno($el)"
                           x-ref="child2RrnoEL"
                           x-init="()=>{
                      Inputmask({mask: '999999-9999999', keepStatic: true, placeholder: '0', autoUnmask: true}).mask($el);
                      $nextTick(()=>validRrno($el))
                    }"
                           :disabled="!child2Use"
                    >
                    <div class="invalid-feedback">주민번호가 이상합니다.🤷‍♀️</div>
                  </div>
                  <div class="col-6">
                    <span class="form-text rrno-info"></span>
                  </div>
                </div>
              </div>

              <div class="col-md-2">
                <input type="tel" id="child2Tel" class="form-control" placeholder="010-0000-0000"
                       x-model="child2Tel"
                       x-init="Inputmask({mask: '999-9999-9999', keepStatic: true, placeholder: '010-0000-0000', autoUnmask: true}).mask($el);"
                       :disabled="!child2Use"
                >

              </div>
            </div>

            <div class="row m-0 p-1">
              <div class="col-md-1 form-check form-switch">
                <label for="child3Use">자녀3</label>
                <input type="checkbox" id="child3Use" role="switch" class="form-check-input" x-model="child3Use">
              </div>

              <div class="col-md-2">
                <input type="text" id="child3Name" class="form-control" placeholder="이름을 입력하세요"
                       x-model="child3Name" :disabled="!child3Use" x-ref="child3NameEL">
              </div>

              <div class="col-md-4">
                <div class="row">
                  <div class="col-6">
                    <input type="text" id="child3Rrno" class="form-control" placeholder="주민번호"
                           x-model="child3Rrno" @keyup="validRrno($el)"
                           x-ref="child3RrnoEL"
                           x-init="()=>{
                      Inputmask({mask: '999999-9999999', keepStatic: true, placeholder: '0', autoUnmask: true}).mask($el);
                      $nextTick(()=>validRrno($el))
                    }"
                           :disabled="!child3Use"
                    >
                    <div class="invalid-feedback">주민번호가 이상합니다.🤷‍♀️</div>
                  </div>
                  <div class="col-6">
                    <span class="form-text rrno-info"></span>
                  </div>
                </div>
              </div>

              <div class="col-md-2">
                <input type="tel" id="child3Tel" class="form-control" placeholder="010-0000-0000"
                       x-model="child3Tel"
                       x-init="Inputmask({mask: '999-9999-9999', keepStatic: true, placeholder: '010-0000-0000', autoUnmask: true}).mask($el);"
                       :disabled="!child3Use"
                >

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>



    <hr>

    <h4>보험 선택 <em :class="filtered?'bi bi-eye-slash text-warning ms-2':'bi bi-eye text-success ms-2'" @click="goFilter()"></em></h4>

    <div class="row table-sm" id="isrPrdTable">

      <!--<table id="isrPrdTable" class="table table-bordered table-hover table-sm" style="font-size: 1em"></table>-->
    </div>

    <div class="row mt-3">
      <div class="col-9 text-end">
        <button class="btn btn-lg btn-success" @click="viewResult()">🐷ㄱㄱ</button>
      </div>
    </div>

    <div class="row bg-info-subtle rounded-3 p-2 mt-3" x-text="toJson(result).length + '/' + defalreResult.length"></div>
    <div class="row bg-warning-subtle rounded-3 p-2 mt-3" @click="copyText($el.innerText)" x-text="toJson(result)"></div>
    <!--<div class="row bg-success-subtle rounded-3 p-2 mt-3" x-text="encodeBase64(toJson(result))" x-ref="result2"></div>-->
    <div class="row bg-primary-subtle rounded-4 p-2 mt-3"
         @click="go()"
         x-text="defalreResult"></div>



  </form>

  <!-- alert와 confirm을 위한 modal -->
  <div class="modal fade" tabindex="-1" id="infoModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary">
          <h4 class="modal-title">보험선택 테스트</h4>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col info-message"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-md btn-info w-25 bi bi-airplane" @click="go(1)">Web 바로가기</button>
          <button class="btn btn-md btn-success w-25 bi bi-link-45deg" @click="go()">바로가기</button>
          <button class="btn btn-md btn-primary w-25" data-bs-dismiss="modal">확인</button>
        </div>
      </div>
    </div>
  </div>
  <!--// modal -->

</div>


<script>

  const modal = new bootstrap.Modal(document.querySelector('#infoModal'))

  function groupStyling(group){
    const selected =  group.getRows().filter(r=> r.isSelected()).length;
    const count = group.getRows().length

    // 다 해제 했을때 스타일링
    if(selected){
      group.getElement().classList.remove('text-decoration-line-through', 'text-muted', 'fst-italic')
    }else{
      group.getElement().classList.add('text-decoration-line-through', 'text-muted', 'fst-italic')
    }

    const countEl = group.getElement().querySelector('span[name=groupCount]')

    const nameEl = group.getElement().querySelector('span[name=groupName]')

    const essYn = group.getRows()[0].getData().essYn;
    console.log(selected, count, essYn)

    if(essYn){
      countEl.classList.remove('text-bg-primary', 'text-bg-warning', 'text-bg-secondary', 'text-bg-success')
      countEl.classList.add('text-bg-success')
      countEl.innerText = selected;

      nameEl.classList.remove('text-bg-primary', 'text-bg-warning', 'text-bg-secondary', 'text-bg-success')
      nameEl.classList.add('text-bg-success')

      return;
    }

    if(!selected){
      countEl.classList.remove('text-bg-primary', 'text-bg-warning', 'text-bg-secondary', 'text-bg-success')
      countEl.classList.add('text-bg-secondary')
      countEl.innerText = selected;

      nameEl.classList.remove('text-bg-primary', 'text-bg-warning', 'text-bg-secondary', 'text-bg-success')
      nameEl.classList.add('text-bg-secondary')

    }else if(selected===count){
      countEl.classList.remove('text-bg-primary', 'text-bg-warning', 'text-bg-secondary', 'text-bg-success')
      countEl.classList.add('text-bg-primary')
      countEl.innerText = selected;

      nameEl.classList.remove('text-bg-primary', 'text-bg-warning', 'text-bg-secondary', 'text-bg-success')
      nameEl.classList.add('text-bg-primary')
    }else{
      countEl.classList.remove('text-bg-primary', 'text-bg-warning', 'text-bg-secondary', 'text-bg-success')
      countEl.classList.add('text-bg-warning')
      countEl.innerText = `${selected}/${count}`;

      nameEl.classList.remove('text-bg-primary', 'text-bg-warning', 'text-bg-secondary', 'text-bg-success')
      nameEl.classList.add('text-bg-warning')
    }
  }

  let isrPrdTable;

  function init() {
    return {
      bseYr: 0,
      chldIsrAgRstcYr: 0,
      pseFnm: '오애순',
      pseRrno: '',
      instNm: '맞춤형복지기관',
      picker: '',
      isrSlcDt: '',
      filtered: false,
      result: '',
      defalreResult: '',
      link: '/bsm/bhdSlcView.html',
      webLink: '/bsm/bhdSlcWebView.html',
      params: '',
      wlfInst: '',

      spsUse: true,
      spsCop: false,
      spsName: '양관식',
      spsRrno: '8811111111111',
      spsTel: '01012345678',

      child1Use: true,
      child1Name: '금명이',
      child1Rrno: '',
      child1Tel: '01056783456',

      child2Use: true,
      child2Name: '은명이',
      child2Rrno: '',
      child2Tel: '',

      child3Use: true,
      child3Name: '동명이',
      child3Rrno: '',
      child3Tel: '',


      loadData(){
        this.bseYr = new Date().getFullYear()+1
        this.chldIsrAgRstcYr = this.bseYr - 19

        // 금명이 19세
        this.child1Rrno = moment(this.chldIsrAgRstcYr -1, 'YYYY').format('YY') + '11114123456';

        // 금명이 15세
        this.child2Rrno = moment(this.bseYr - 14, 'YYYY').format('YY') + '11113123456';

        // 동명이 14세
        this.child3Rrno = moment(this.bseYr - 13, 'YYYY').format('YY') + '11113123456';

        const start = moment().subtract(1, 'month').format('YYYY-MM-DD');
        const end = moment().add(1, 'month').format('YYYY-MM-DD');

        this.picker = new easepick.create({
          element: this.$refs.isrSlcDt,
          css:[
            'https://www.gwp.or.kr/js/lib/easepick/index.min.css'
          ],
          lang: 'ko-KR',
          plugins:['RangePlugin', 'LockPlugin'],
          zIndex: 2000,
          RangePlugin: {
            tooltipNumber(num){
              return num;
            },
            locale:{
              one: '일',
              other: '일'
            },
            startDate: start,
            endDate: end,
          },
          LockPlugin: {
            minDate: start,
            maxDate: end,
          },
          autoApply: true,
        })

        isrPrdTable = getTabulator()

        isrPrdTable.on('rowSelectionChanged', (_data, _row, _selected, _deselected)=>{
          console.log('rowSelectionChanged', _selected, _deselected)// row.getData(), row.getGroup().getRows('active'), row.getGroup(), row)

          const rows = (_selected && _selected.length)?_selected:_deselected

          rows.forEach(r=>r.update({selected: r.isSelected()}))

          const groups = new Set(rows.map(g=>g.getGroup()))

          groups.forEach(groupStyling)
        })

        isrPrdTable.on('rowSelected', (row)=>{
          //console.log('rowSelected', row.getData(), row.getGroup().getRows('active'), row.getGroup(), row)
        })

        isrPrdTable.on('rowDeselected', (row)=>{

          //row.getGroup().getRows(true).forEach(r=>console.log(r))
          //if(row.getData().essYn || row.getData().essYn === 'Y') return row.select()

        })

        isrPrdTable.on('tableBuilt', ()=>{
          isrPrdTable.selectRow()


          /**
           * 보험 필수여부 변경했을때
           */
          Array.from(document.querySelectorAll('input[type=checkbox][id^=essYn-]')).forEach(el=>{
            el.addEventListener('change', (evt)=>{
              console.log('change', evt.target.checked, evt.target.dataset.isrprdcd,  evt.target.id, evt.target)

              const group = isrPrdTable.getGroups().find(g=>g.getKey() === evt.target.dataset.isrprdcd)

              group.getRows().forEach(r=>{
                r.update({essYn: evt.target.checked?'Y':'N'})
                if(evt.target.checked){
                  r.select()
                  r.getElement().classList.add('bg-success')
                }else{
                  r.getElement().classList.remove('bg-success')
                }
              } )

              groupStyling(group)
            })
          })
        })

      },
      getRstcYr(){
        return `만 ${this.bseYr -this.chldIsrAgRstcYr} 세`
      },
      validFnm(){
        return validateName(this.pseFnm)
      },
      validRrno(target){

        if(!target) return validateSsn(this.pseRrno)

        const ssn = target.value

        const rrnoInfo = target.parentElement.nextElementSibling.querySelector('span.rrno-info')

        console.log('validRrno', target, 'rrnoInfo', rrnoInfo, 'ssn', ssn)

        rrnoInfo.innerHTML = ''

        if(ssn.length === 13){
          if(validateSsn(ssn)){

            const {tgrAg, birthday, tgrSxClCd} = calcSsn(ssn, this.bseYr)

            rrnoInfo.innerText = `성별: ${tgrSxClCd==='1'?'남자':'여자'}
            생년월일: ${moment(birthday).format('YYYY년 M월 D일')}
            보험나이: ${tgrAg}세`

            if(tgrAg<0){
              alert('0세 미만입니다')
              target.classList.remove('is-valid');
              target.classList.add('is-invalid');

              rrnoInfo.classList.add('text-danger')
            }

            if(!target.id.startsWith('child') && tgrAg<19){
              alert('미성년자 입니다')
              target.classList.remove('is-valid');
              target.classList.add('is-invalid');
              rrnoInfo.classList.add('text-danger')
            }else{
              target.classList.remove('is-invalid');
              target.classList.add('is-valid');
              rrnoInfo.classList.remove('text-danger')
            }

          }else{
            target.classList.remove('is-valid');
            target.classList.add('is-invalid');
            rrnoInfo.classList.remove('text-danger')
          }
        }
      },
      goFilter(){
        this.filtered = !this.filtered;

        if(this.filtered){
          isrPrdTable.setFilter('selected', '=', true)
        }else{
          isrPrdTable.clearFilter()
        }

      },
      validate(){
        console.log(this.validFnm(this.pseFnm), this.validRrno(), this.bseYr, this.chldIsrAgRstcYr, this.picker.value, this.picker, (this.validFnm(this.pseFnm), this.validRrno(), this.bseYr, this.chldIsrAgRstcYr, this.picker.value))

        return this.validFnm(this.pseFnm) && this.validRrno() && this.bseYr && this.chldIsrAgRstcYr && this.picker.getStartDate() && this.picker.getEndDate()
      },
      validateAndGetFmlInfo(){

        const check = (name, rrno, tel, nameEL, rrnoEL, isrrClCd)=>{
          console.debug('check', name, rrno, tel, nameEL, rrnoEL, isrrClCd)

          if(!validateName(name)){
            alert('성명을 바르게 입력해주세요')
            nameEL.focus();
            return false;
          }

          if(!validateSsn(rrno)){
            alert('주민번호를 바르게 입력하세요')
            rrnoEL.classList.remove('is-valid');
            rrnoEL.classList.add('is-invalid');
            return false;
          }else{
            rrnoEL.classList.remove('is-invalid');
            rrnoEL.classList.add('is-valid');
          }

          const {tgrAg, birthday, tgrSxClCd} = calcSsn(rrno, this.bseYr)

          return {
            isrrClCd,
            name,
            tel,
            rrno,
            sxClCd: tgrSxClCd,
            age: tgrAg,
          }
        }

        const fmlInfo = []

        console.log(`this.spsUse`, this.spsUse)

        if(this.spsUse){
          const sps = check(this.spsName, this.spsRrno, this.spsTel, this.$refs.spsNameEL, this.$refs.spsRrnoEL, '1')

          console.log(`sps`, sps)
          if(!sps){
            return false;
          }

          sps.isCop = this.spsCop;

          fmlInfo.push(sps);

        }

        for(let i=1; i<4; i++){
          console.log(`this[child${i}Use]`, this[`child${i}Use`])

          if(this[`child${i}Use`]){
            const child = check(this[`child${i}Name`], this[`child${i}Rrno`], this[`child${i}Tel`]
              , this.$refs[`child${i}NameEL`], this.$refs[`child${i}RrnoEL`], '3')

            if(!child){
              return false;
            }

            fmlInfo.push(child);
          }
        }

        console.log('this.fmlInfo', fmlInfo)

        return fmlInfo;

      },
      viewResult(){

        if(!this.validate()){

          alert('데이터를 다 입력하세요');

          return '';
        }

        const fmlInfo = this.validateAndGetFmlInfo();

        if(!fmlInfo){
          alert('가족정보를 바르게 입력해주세요');
          return;
        }

        const groups = isrPrdTable.getGroups()
        console.log('groups', groups);

        function tableToData(group){
          const dtls = group.getRows().filter(d=>d.getData().selected).map(d=>d.getData())

          if(!dtls || !dtls.length) return;

          console.log('tableToData', dtls[0])

          return ({isrPrdCd: group.getKey(), isrPrdNm: dtls[0].isrPrdNm, essYn: dtls[0].essYn, isrrClCd: dtls[0].isrrClCd, isrrClNm: dtls[0].isrrClNm
            , dtlCdList: dtls.map(d=>({
              isrPrdCd: d.isrPrdCd,
              isrPrdNm: d.isrPrdNm,
              isrDtlCd: d.isrDtlCd,
              isrDtlNm: d.isrDtlNm,
              isrrClCd: d.isrrClCd,
              isrrClNm: d.isrrClNm,
              mIsrUprCd: d.mIsrUprCd,
              mIsrSbcAmt: d.mIsrSbcAmt,
              mIsrSbcScr: (d.mIsrSbcAmt/1000).toFixed(2),
              fIsrUprCd: d.fIsrUprCd,
              fIsrSbcAmt: d.fIsrSbcAmt,
              fIsrSbcScr: (d.fIsrSbcAmt/1000).toFixed(2)
            }))
          })
        }

        this.wlfInst = {
          wlfInstNm: this.instNm,
          chldIsrAgRstcYr: this.chldIsrAgRstcYr,
          bhdSlcBgnDt: this.picker.getStartDate().format('YYYYMMDD'),
          bhdSlcNdDt: this.picker.getEndDate().format('YYYYMMDD'),
          isrBgnDt: `${this.bseYr}.01.01`,
          isrNdDt: `${this.bseYr}.12.31`
        }

        this.result = {
          pseInfo: {
            pseFnm: this.pseFnm,
            pseRrno: this.pseRrno
          },
          wlfInst: this.wlfInst,
          bseYr: this.bseYr,
          rtnList: groups.filter(g=>{
            console.log('group', g.getRows().find(d=>d.getData().selected))
            return g.getRows().find(d=>d.getData().selected)
          }).map(tableToData),
          fmlInfo,
        }

        this.defalreResult = byteToBase64(pako.deflate(toJson(this.result), {level: 9}))

        this.makeQr()

      },
      makeQr(){

        const modalBody = document.querySelector('div.modal-body div.row');
        modalBody.innerHTML = ''

        const infoDiv = document.createElement('div');
        infoDiv.classList.add('col', 'info-message')//document.querySelector('.info-message');

        modalBody.append(infoDiv);

        this.params = `bseYr=${this.bseYr}&token=${encodeURIComponent(this.defalreResult)}&wlfInst=${encodeURI(JSON.stringify(this.wlfInst))}`

        infoDiv.addEventListener('click', this.go)

        console.log('makeQr',infoDiv, this.link.length, this.link)

        const qrcode = new QRCode(infoDiv, {
          text: `https://www.gwp.or.kr${this.link}`,
          width : 500,
          height : 500,
          correctLevel: QRCode.CorrectLevel.L,
        })

        modal.show()

      },
      go(to){
        if (!this.link) return;

        if (to === 1) {

          console.log('go', to, this.webLink)
          window.open(`${this.webLink}?${this.params}`, 'bhdSlcWebTest')

        } else {
          console.log('go', to, this.link)

          window.open(`${this.link}?${this.params}`, 'bhdSlcTest')
        }

      },


    }// end return
  }// end init()

  function cellEdited(cell){
    console.log('cellEdited', cell.getElement(), cell.getElement().classList, cell);
    cell.getElement().classList.add('bg-danger', 'opacity-75', 'border', 'border-danger')
  }

  function checkEssYn(cell){
    return cell.getRow().getData().essYn !== 'Y'
  }

  function groupOnOff(onOff, isrPrdCd){

    console.group('groupOnOff',onOff, isrPrdCd)

    const group = isrPrdTable.getGroups().find(g=>g.getKey() === isrPrdCd)

    const rows = group.getRows()

    rows.forEach(r=> {

      console.dir(r)
      console.log('r', r.getIndex(), r)

      if(onOff){
        r.select()
      }else{
        r.deselect()
      }

    })

    console.groupEnd()

  }


  function groupHeader(value, count, data, group){

    const selected =  group.getRows().filter(r=> r.isSelected()).length;

    // 다 해제 했을때 스타일링
    if(selected){
      group.getElement().classList.remove('text-decoration-line-through', 'text-muted', 'fst-italic')
    }else{
      group.getElement().classList.add('text-decoration-line-through', 'text-muted', 'fst-italic')
    }

    const textBg = data[0].essYn?'text-bg-success':!selected?'text-bg-secondary':selected===count?'text-bg-primary':'text-bg-warning';

console.log(data[0].isrPrdCd, !!data[0].checked)

    return `<span class="form-check form-check-inline form-switch">
  <input type="checkbox" id="useYn-${data[0].isrPrdCd}" class="form-check-input" role="switch"
    checked="${!!data[0].checked}"
    onChange="groupOnOff(this.checked, '${data[0].isrPrdCd}')">
</span>
<span name="groupName" class="${textBg} px-2">${data[0].isrPrdNm}</span> <span class="text-secondary">[${value}]</span>
<input type="checkbox" class="form-check-input form-control-md" name="essYn" id="essYn-${data[0].isrPrdCd}" data-isrPrdCd="${data[0].isrPrdCd}" ${data[0].essYn?'checked':''}>
<label for="essYn-${data[0].isrPrdCd}" class="form-check-label"> 필수여부</label>
 <span class="badge opacity-50 ${textBg}" name="groupCount">${count===selected?count:selected +'/'+count}</span>`

  }

  function getTabulator(){
    return new Tabulator('#isrPrdTable', {
      groupBy: 'isrPrdCd',
      groupHeader,
      reactiveData: true,
      rowFormatter: (row)=>{
        if(row.getData().essYn) row.getElement().classList.add('bg-success')
      },
      columns: [
        {formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center",
          headerSort:false, titleFormatterParams: {rowRange: 'active'},
          //editable: checkEssYn,
        },
        {field: 'isrPrdCd', title: '보험코드'},
        {field: 'isrPrdNm', title: '보험명'},
        {field: 'isrrClCd', title: '대상코드'},// visible: false},
        {field: 'isrrClNm', title: '대상'},
        {field: 'essYn', title: '필수여부',  formatter: 'tickCross', hozAlign: 'center', mutator: (value)=>value==='Y', cellEdited: cellEdited},
        {field: 'isrDtlCd', title: '상세코드'},
        {field: 'isrDtlNm', title: '상세명', cssClass: 'fw-bold'},
        {field: 'mIsrSbcAmt', title: '남자가격', hozAlign: 'right', formatter: 'money', formatterParams: {precision: false}
          , editor: 'number', editorParams: {min:0, step: 100}, cellEdited: cellEdited},
        {field: 'fIsrSbcAmt', title: '여자가격', hozAlign: 'right',  formatter: 'money', formatterParams: {precision: false}
          , editor: 'number', editorParams: {min:0, step: 100}, cellEdited: cellEdited},
        {field: 'selected', visible: false},
      ],
      data: allIsrPrd.map(d=> ({
        isrPrdCd: d.isrPrdCd,
        isrPrdNm: d.isrPrdNm,
        isrDtlCd: d.isrDtlCd,
        isrDtlNm: d.isrDtlNm,
        isrrClCd: d.isrrClCd,
        isrrClNm: d.isrrClNm,
        essYn: d.essYn,
        mIsrUprCd: d.mIsrUprCd,
        mIsrSbcAmt: d.mIsrSbcAmt,
        mIsrSbcScr: d.mIsrSbcScr,
        fIsrUprCd: d.fIsrUprCd,
        fIsrSbcAmt: d.fIsrSbcAmt,
        fIsrSbcScr: d.fIsrSbcScr,
      })).sort((a,b)=> parseInt(a.isrrClCd) - parseInt(b.isrrClCd)
        || ((a.essYn < b.essYn)?1:(a.essYn > b.essYn)?-1:0)
        || ((a.isrPrdCd > b.isrPrdCd)?1:(a.isrPrdCd < b.isrPrdCd)?-1:0)
        || (a.mIsrSbcAmt - b.mIsrSbcAmt)
        || ((a.isrDtlCd > b.isrDtlCd)?1:(a.isrDtlCd < b.isrDtlCd)?-1:0)
      ),
    })
  }



  var allIsrPrd =  [
    {
      "isrPrdCd": "IL0001",
      "isrPrdNm": "생명/상해",
      "isrDtlCd": "IM0184",
      "isrDtlNm": "1억원",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "Y",
      "mIsrUprCd": "IU2025ABC000000000IL0001IM018401Y000",
      "mIsrSbcAmt": 192400,
      "mIsrSbcScr": 192.4,
      "fIsrUprCd": "IU2025ABC000000000IL0001IM018402Y000",
      "fIsrSbcAmt": 117120,
      "fIsrSbcScr": 117.12,
      checked: true,
    },
    {
      "isrPrdCd": "IL0001",
      "isrPrdNm": "생명/상해",
      "isrDtlCd": "IM0186",
      "isrDtlNm": "2억원",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "Y",
      "mIsrUprCd": "IU2025ABC000000000IL0001IM018601Y000",
      "mIsrSbcAmt": 362630,
      "mIsrSbcScr": 362.63,
      "fIsrUprCd": "IU2025ABC000000000IL0001IM018602Y000",
      "fIsrSbcAmt": 216730,
      "fIsrSbcScr": 216.73
    },
    {
      "isrPrdCd": "IL0001",
      "isrPrdNm": "생명/상해",
      "isrDtlCd": "IM0237",
      "isrDtlNm": "5천만원",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "Y",
      "mIsrUprCd": "IU2025ABC000000000IL0001IM023701Y000",
      "mIsrSbcAmt": 49800,
      "mIsrSbcScr": 49.8,
      "fIsrUprCd": "IU2025ABC000000000IL0001IM023702Y000",
      "fIsrSbcAmt": 24830,
      "fIsrSbcScr": 24.83
    },
    {
      "isrPrdCd": "IL0002",
      "isrPrdNm": "의료비 보장",
      "isrDtlCd": "IM0212",
      "isrDtlNm": "미가입",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "Y",
      "mIsrUprCd": "IU2025ABC000000000IL0002IM021201Y000",
      "mIsrSbcAmt": 0,
      "mIsrSbcScr": 0,
      "fIsrUprCd": "IU2025ABC000000000IL0002IM021202Y000",
      "fIsrSbcAmt": 0,
      "fIsrSbcScr": 0,
      checked: true,
    },
    {
      "isrPrdCd": "IL0002",
      "isrPrdNm": "의료비 보장",
      "isrDtlCd": "IM0243",
      "isrDtlNm": "급여·비급여 각3천만원·통원 각15만원+특약",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "Y",
      "mIsrUprCd": "IU2025ABC000000000IL0002IM024301Y000",
      "mIsrSbcAmt": 281090,
      "mIsrSbcScr": 281.09,
      "fIsrUprCd": "IU2025ABC000000000IL0002IM024302Y000",
      "fIsrSbcAmt": 348760,
      "fIsrSbcScr": 348.76
    },
    {
      "isrPrdCd": "IL0010",
      "isrPrdNm": "특정질병 진단비(암, 뇌졸중, 급성심근경색)",
      "isrDtlCd": "IM0040",
      "isrDtlNm": "각 1천만 원",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0010IM004001Y000",
      "mIsrSbcAmt": 13480,
      "mIsrSbcScr": 13.48,
      "fIsrUprCd": "IU2025ABC000000000IL0010IM004002Y000",
      "fIsrSbcAmt": 3880,
      "fIsrSbcScr": 3.88,
      checked: false,
    },
    {
      "isrPrdCd": "IL0010",
      "isrPrdNm": "특정질병 진단비(암, 뇌졸중, 급성심근경색)",
      "isrDtlCd": "IM0041",
      "isrDtlNm": "각 2천만 원",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0010IM004101Y000",
      "mIsrSbcAmt": 23480,
      "mIsrSbcScr": 23.48,
      "fIsrUprCd": "IU2025ABC000000000IL0010IM004102Y000",
      "fIsrSbcAmt": 8880,
      "fIsrSbcScr": 88.8
    },
    {
      "isrPrdCd": "IL0011",
      "isrPrdNm": "순직사망",
      "isrDtlCd": "IM0217",
      "isrDtlNm": "1억원",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0011IM021701Y000",
      "mIsrSbcAmt": 23480,
      "mIsrSbcScr": 23.48,
      "fIsrUprCd": "IU2025ABC000000000IL0011IM021702Y000",
      "fIsrSbcAmt": 7890,
      "fIsrSbcScr": 78.9,
      checked: false,
    },
    {
      "isrPrdCd": "IL0011",
      "isrPrdNm": "순직사망",
      "isrDtlCd": "IM0218",
      "isrDtlNm": "5천만원",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0011IM021801Y000",
      "mIsrSbcAmt": 8030,
      "mIsrSbcScr": 8.03,
      "fIsrUprCd": "IU2025ABC000000000IL0011IM021802Y000",
      "fIsrSbcAmt": 8030,
      "fIsrSbcScr": 8.03
    },
    {
      "isrPrdCd": "IL0011",
      "isrPrdNm": "순직사망",
      "isrDtlCd": "IM0233",
      "isrDtlNm": "1억원(소방)",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0011IM023301Y000",
      "mIsrSbcAmt": 12200,
      "mIsrSbcScr": 12.2,
      "fIsrUprCd": "IU2025ABC000000000IL0011IM023302Y000",
      "fIsrSbcAmt": 5180,
      "fIsrSbcScr": 5.18
    },
    {
      "isrPrdCd": "IL0011",
      "isrPrdNm": "순직사망",
      "isrDtlCd": "IM0234",
      "isrDtlNm": "2억원(경찰)",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0011IM023401Y000",
      "mIsrSbcAmt": 16960,
      "mIsrSbcScr": 16.96,
      "fIsrUprCd": "IU2025ABC000000000IL0011IM023402Y000",
      "fIsrSbcAmt": 8240,
      "fIsrSbcScr": 8.24
    },
    {
      "isrPrdCd": "IL0017",
      "isrPrdNm": "배우자_암 진단비",
      "isrDtlCd": "IM0055",
      "isrDtlNm": "1천만원",
      "isrrClCd": "1",
      "isrrClNm": "배우자",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0017IM005511Y000",
      "mIsrSbcAmt": 54380,
      "mIsrSbcScr": 54.38,
      "fIsrUprCd": "IU2025ABC000000000IL0017IM005512Y000",
      "fIsrSbcAmt": 44500,
      "fIsrSbcScr": 44.5,
      checked: false,
    },
    {
      "isrPrdCd": "IL0017",
      "isrPrdNm": "배우자_암 진단비",
      "isrDtlCd": "IM0226",
      "isrDtlNm": "2천만원",
      "isrrClCd": "1",
      "isrrClNm": "배우자",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0017IM022611Y000",
      "mIsrSbcAmt": 93390,
      "mIsrSbcScr": 93.39,
      "fIsrUprCd": "IU2025ABC000000000IL0017IM022612Y000",
      "fIsrSbcAmt": 120020,
      "fIsrSbcScr": 120.02
    },
    {
      "isrPrdCd": "IL0033",
      "isrPrdNm": "배우자 생명/상해",
      "isrDtlCd": "IM0200",
      "isrDtlNm": "1억원",
      "isrrClCd": "1",
      "isrrClNm": "배우자",
      "essYn": "Y",
      "mIsrUprCd": "IU2025ABC000000000IL0033IM020011Y000",
      "mIsrSbcAmt": 239220,
      "mIsrSbcScr": 239.22,
      "fIsrUprCd": "IU2025ABC000000000IL0033IM020012Y000",
      "fIsrSbcAmt": 110440,
      "fIsrSbcScr": 110.44,
      checked: false,
    },
    {
      "isrPrdCd": "IL0034",
      "isrPrdNm": "배우자 의료비 보장",
      "isrDtlCd": "IM0230",
      "isrDtlNm": "급여·비급여 각3천만원·통원 각15만원+특약",
      "isrrClCd": "1",
      "isrrClNm": "배우자",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0034IM023011Y000",
      "mIsrSbcAmt": 240600,
      "mIsrSbcScr": 240.6,
      "fIsrUprCd": "IU2025ABC000000000IL0034IM023012Y000",
      "fIsrSbcAmt": 255920,
      "fIsrSbcScr": 255.92,
      checked: false,
    },
    {
      "isrPrdCd": "IL0035",
      "isrPrdNm": "자녀 의료비 보장",
      "isrDtlCd": "IM0228",
      "isrDtlNm": "급여·비급여 각3천만원·통원 각15만원+특약",
      "isrrClCd": "3",
      "isrrClNm": "자녀",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0035IM022831Y000",
      "mIsrSbcAmt": 46310,
      "mIsrSbcScr": 46.31,
      "fIsrUprCd": "IU2025ABC000000000IL0035IM022832Y000",
      "fIsrSbcAmt": 51710,
      "fIsrSbcScr": 51.71,
      checked: true,
    },
    {
      "isrPrdCd": "IL0036",
      "isrPrdNm": "수술비 / 입원비 및 대상포진 진단비",
      "isrDtlCd": "IM0246",
      "isrDtlNm": "수술비(50만원)+입원일당 의료비(3만원)+대상포진 진단비(1백만원)\n",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0036IM024601Y000",
      "mIsrSbcAmt": 13940,
      "mIsrSbcScr": 13.94,
      "fIsrUprCd": "IU2025ABC000000000IL0036IM024602Y000",
      "fIsrSbcAmt": 19660,
      "fIsrSbcScr": 19.66,
      checked: false,
    },
    {
      "isrPrdCd": "IL0040",
      "isrPrdNm": "치아보험",
      "isrDtlCd": "IM0265",
      "isrDtlNm": "보존치료(5만원)+보철치료(30만원)",
      "isrrClCd": "0",
      "isrrClNm": "본인",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0040IM026501Y000",
      "mIsrSbcAmt": 89430,
      "mIsrSbcScr": 89.43,
      "fIsrUprCd": "IU2025ABC000000000IL0040IM026502Y000",
      "fIsrSbcAmt": 79450,
      "fIsrSbcScr": 79.45,
      checked: false,
    },
    {
      "isrPrdCd": "IL0041",
      "isrPrdNm": "자녀_골절/화상진단비",
      "isrDtlCd": "IM0266",
      "isrDtlNm": "골절(50만원)+화상(20만원)",
      "isrrClCd": "3",
      "isrrClNm": "자녀",
      "essYn": "N",
      "mIsrUprCd": "IU2025ABC000000000IL0041IM026631Y000",
      "mIsrSbcAmt": 24310,
      "mIsrSbcScr": 24.31,
      "fIsrUprCd": "IU2025ABC000000000IL0041IM026632Y000",
      "fIsrSbcAmt": 32710,
      "fIsrSbcScr": 32.71,
      checked: true,
    },
  ]


</script>
</body>
</html>
